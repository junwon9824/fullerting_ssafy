name: Deploy Backend

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. μ½”λ“ μ²΄ν¬μ•„μ›ƒ
      - name: Checkout repo
        uses: actions/checkout@v3

      # 2. Kubeconfig μ„¤μ • λ° IP κ°•μ  μμ • (ν•λ‚μ λ‹¨κ³„λ΅ ν†µν•©)
      - name: Setup kubeconfig and Force IP
        run: |
          mkdir -p ~/.kube
          # Secret λ°μ΄ν„°λ¥Ό λ””μ½”λ”©ν•μ—¬ ~/.kube/config νμΌ μƒμ„±
          echo "${{ secrets.KUBECONFIG_DATA }}" | base64 --decode > ~/.kube/config
          # π¨ μ¤‘μ”ν• μμ •: 127.0.0.1 μ£Όμ†λ¥Ό Host-Only IPλ΅ κ°•μ  κµμ²΄
          sed -i 's|https://127.0.0.1:6443|https://10.0.1.93:6443|g' ~/.kube/config
          # ν™κ²½ λ³€μ μ„¤μ • λ° κ¶ν• λ¶€μ—¬
          export KUBECONFIG=~/.kube/config
          chmod 600 ~/.kube/config
          echo "KUBECONFIG created and IP forced to 10.0.1.93"
          cat ~/.kube/config | grep server
          # μ΄μ  IPκ°€ μμ •λμ—μΌλ‹ λ…Έλ“ λ©λ΅μ„ ν™•μΈν•©λ‹λ‹¤ (μ΄ λ‹¨κ³„κ°€ μ„±κ³µν•΄μ•Ό ν•©λ‹λ‹¤!)
          kubectl get nodes

      # 3. Apply all Kubernetes manifests (μ΄μ „κ³Ό λ™μΌ)
      - name: Apply all Kubernetes manifests
        run: |
          export KUBECONFIG=~/.kube/config
          kubectl apply -f k8s/ --recursive
