name: Deploy Backend to K3s

on:
  push:
    branches:
      - main

jobs:
  deploy:
    # 1. λ¬λ„ μ§€μ •: Self-Hosted Runner (fuller2 VM) μ‚¬μ©
    runs-on: self-hosted

    steps:
      # 1. μ½”λ“ μ²΄ν¬μ•„μ›ƒ
      - name: Checkout repo
        uses: actions/checkout@v4

      # 2. kubectl μ„¤μΉ ν™•μΈ λ° μ„¤μΉ (Self-hosted λ¬λ„μ— μ—†μ„ κ²½μ°)
      - name: Ensure kubectl is installed
        run: |
          if ! command -v kubectl >/dev/null 2>&1; then
            echo "kubectl not found. Installing..."
            curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
            sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
          else
            echo "kubectl is already installed."
          fi
          # --short ν”λκ·Έλ¥Ό μ κ±°ν•μ—¬ μ¤λλ kubectl λ²„μ „κ³Όμ νΈν™μ„± λ¬Έμ  ν•΄κ²°
          kubectl version --client

      # 3. Kubeconfig μ„¤μ • λ° IP κ°•μ  μμ • (Secretsλ΅ μ „λ‹¬λ base64 λ°μ΄ν„° μ‚¬μ©)
      - name: Setup kubeconfig and Force IP
        run: |
          # π¨ K3s λ§μ¤ν„° λ…Έλ“μ μ‹¤μ  Private IPλ΅ λ³€κ²½
          MASTER_IP="10.0.1.93" 

          mkdir -p ~/.kube
          # KUBECONFIG_DATA μ‹ν¬λ¦Ώμ„ λ””μ½”λ”©ν•λ©° μ¤„λ°”κΏ/μΊλ¦¬μ§€ λ¦¬ν„΄/κ³µλ°± λ¬Έμλ¥Ό μ κ±°ν•κ³  νμΌμ„ μƒμ„±ν•©λ‹λ‹¤.
          echo "${{ secrets.KUBECONFIG_DATA }}" | tr -d ' \n\r' | base64 -d > ~/.kube/config

          # Kubeconfig λ‚΄μ μ„λ²„ μ£Όμ†λ¥Ό λ§μ¤ν„° λ…Έλ“μ μ‹¤μ  Private IPλ΅ κ°•μ  λ³€κ²½
          # Kubeconfig λ‚΄μ λ¨λ“  IP μ£Όμ†λ¥Ό ${MASTER_IP}λ΅ κµμ²΄ν•©λ‹λ‹¤.
          sed -i "s|https://.*:6443|https://${MASTER_IP}:6443|g" ~/.kube/config

          export KUBECONFIG=~/.kube/config
          chmod 600 ~/.kube/config
          echo "KUBECONFIG set and IP forced to ${MASTER_IP}"

          # ===================================================
          # π¨ λ””λ²„κΉ… λ‹¨κ³„: μ—°κ²° μ‹¤ν¨ μ›μΈ μ§„λ‹¨ (κ°€μ¥ μ¤‘μ”)
          # ===================================================
          echo "--- Kubeconfig λ‚΄μ© (μ„λ²„ μ£Όμ† ν™•μΈ) ---"
          # Kubeconfig νμΌ λ‚΄μ μ„λ²„ μ£Όμ†κ°€ μ •ν™•ν μμ •λμ—λ”μ§€ ν™•μΈν•©λ‹λ‹¤.
          cat ~/.kube/config | grep server

          echo "--- K3s API μ„λ²„ μ ‘μ† ν…μ¤νΈ (curl -k μ‚¬μ©) ---"
          # -k: μΈμ¦μ„ κ²€μ¦ λ¬΄μ‹. λ„¤νΈμ›ν¬ μ—°κ²° μμ²΄(TCP)κ°€ λλ”μ§€ ν™•μΈμ΄ λ©μ μ…λ‹λ‹¤.
          # curl λ΅κ·Έλ¥Ό ν†µν•΄ μ—°κ²° μ‹κ°„ μ΄κ³Ό(Timeout), μ—°κ²° κ±°λ¶€(Connection refused) λ“±μ λ„¤νΈμ›ν¬ μ¤λ¥λ¥Ό ν™•μΈν•  μ μμµλ‹λ‹¤.
          curl -kvv https://${MASTER_IP}:6443/api/v1/nodes

          # ===================================================

          # μ—°κ²° μ§„λ‹¨ (μ΄ λ¶€λ¶„μ΄ μ„±κ³µν•΄μ•Ό λ‹¤μ λ‹¨κ³„λ΅ λ„μ–΄κ° μ μμµλ‹λ‹¤)
          kubectl get nodes

      # 4. μ „μ²΄ k8s λ””λ ‰ν† λ¦¬ μ μ©
      - name: Apply all Kubernetes manifests
        run: |
          kubectl apply -f k8s/ --recursive

          # λ°°ν¬ λ΅¤μ•„μ›ƒ μƒνƒ ν™•μΈ (μ•μ •μ„± κ°•ν™”)
          kubectl rollout status deployment/fullerting-backend-deployment --timeout=480s
