name: Deploy Fullerting Backend to k3s

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted
    env:
      KUBECONFIG: $HOME/.kube/config # 모든 step에서 사용

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # K3s cluster에 이미 존재하는 이미지 사용하므로 build/push 제거
      # - name: Build and Push Docker Image
      #   uses: docker/build-push-action@v5
      #   with:
      #     context: ./backend
      #     push: true
      #     tags: ghcr.io/junwon9824/fullerting_ssafy/backend:latest

      - name: Setup Kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG_DATA }}" | base64 --decode > $HOME/.kube/config
          export KUBECONFIG=$HOME/.kube/config

      - name: Deploy MySQL
        run: |
          kubectl apply -f k8s/mysql-config.yaml --validate=false
          kubectl apply -f k8s/mysql-secret.yml --validate=false
          kubectl apply -f k8s/mysql-pv-claim.yaml --validate=false
          kubectl apply -f k8s/mysql-deployment.yml --validate=false
          kubectl apply -f k8s/mysql-service.yaml --validate=false

      - name: Deploy Redis
        run: |
          kubectl apply -f k8s/redis.yml --validate=false

      - name: Deploy Backend
        run: |
          kubectl apply -f k8s/backend-manifest.yml --validate=false
          kubectl rollout status deployment/fullerting-backend-deployment

      - name: Deploy Kafka
        run: |
          kubectl apply -f k8s/kafka.yml --validate=false
