name: Deploy Backend to K3s

on:
  push:
    branches:
      - main

jobs:
  deploy:
    # 1. ëŸ¬ë„ˆ ì§€ì •: Self-Hosted Runner (fuller2 VM) ì‚¬ìš©
    runs-on: self-hosted

    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout repo
        uses: actions/checkout@v4

      # 2. kubectl ì„¤ì¹˜ í™•ì¸ ë° ì„¤ì¹˜ (Self-hosted ëŸ¬ë„ˆì— ì—†ì„ ê²½ìš°)
      - name: Ensure kubectl is installed
        run: |
          if ! command -v kubectl >/dev/null 2>&1; then
            echo "kubectl not found. Installing..."
            curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
            sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
          else
            echo "kubectl is already installed."
          fi
          # --short í”Œë˜ê·¸ë¥¼ ì œê±°í•˜ì—¬ ì˜¤ë˜ëœ kubectl ë²„ì „ê³¼ì˜ í˜¸í™˜ì„± ë¬¸ì œ í•´ê²°
          kubectl version --client

      # 3. Kubeconfig ì„¤ì • ë° IP ê°•ì œ ìˆ˜ì • (Secretsë¡œ ì „ë‹¬ëœ base64 ë°ì´í„° ì‚¬ìš©)
      - name: Setup kubeconfig and Force IP
        run: |
          # ğŸš¨ K3s ë§ˆìŠ¤í„° ë…¸ë“œì˜ ì‹¤ì œ Private IPë¥¼ ë‚´ë¶€ ë£¨í”„ë°± ì£¼ì†Œë¡œ ë³€ê²½í•©ë‹ˆë‹¤.
          # Runnerê°€ ë§ˆìŠ¤í„° ë…¸ë“œì™€ ê°™ì€ VMì— ìˆê¸° ë•Œë¬¸ì— 127.0.0.1ì„ ì‚¬ìš©í•˜ë©´ IPv6 ë¦¬ìŠ¤ë‹ ë¬¸ì œê°€ í•´ê²°ë©ë‹ˆë‹¤.
          MASTER_IP="127.0.0.1" 

          mkdir -p ~/.kube
          # KUBECONFIG_DATA ì‹œí¬ë¦¿ì„ ë””ì½”ë”©í•˜ë©° ì¤„ë°”ê¿ˆ/ìºë¦¬ì§€ ë¦¬í„´/ê³µë°± ë¬¸ìë¥¼ ì œê±°í•˜ê³  íŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤.
          echo "${{ secrets.KUBECONFIG_DATA }}" | tr -d ' \n\r' | base64 -d > ~/.kube/config

          # Kubeconfig ë‚´ì˜ ì„œë²„ ì£¼ì†Œë¥¼ ë‚´ë¶€ ë£¨í”„ë°± ì£¼ì†Œë¡œ ê°•ì œ ë³€ê²½
          # Kubeconfig ë‚´ì˜ ëª¨ë“  IP ì£¼ì†Œë¥¼ ${MASTER_IP}ë¡œ êµì²´í•©ë‹ˆë‹¤.
          sed -i "s|https://.*:6443|https://${MASTER_IP}:6443|g" ~/.kube/config

          export KUBECONFIG=~/.kube/config
          chmod 600 ~/.kube/config
          echo "KUBECONFIG set and IP forced to ${MASTER_IP} (Loopback)"

          # ===================================================
          # ğŸš¨ ë””ë²„ê¹… ë‹¨ê³„: ì—°ê²° ì‹¤íŒ¨ ì›ì¸ ì§„ë‹¨ (ê°€ì¥ ì¤‘ìš”)
          # ===================================================
          echo "--- Kubeconfig ë‚´ìš© (ì„œë²„ ì£¼ì†Œ í™•ì¸) ---"
          # Kubeconfig íŒŒì¼ ë‚´ì˜ ì„œë²„ ì£¼ì†Œê°€ ì •í™•íˆ ìˆ˜ì •ë˜ì—ˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
          cat ~/.kube/config | grep server

          echo "--- K3s API ì„œë²„ ì ‘ì† í…ŒìŠ¤íŠ¸ (curl -k ì‚¬ìš©) ---"
          # -k: ì¸ì¦ì„œ ê²€ì¦ ë¬´ì‹œ. ì´ì œ 127.0.0.1ë¡œ ì ‘ì†ì„ ì‹œë„í•©ë‹ˆë‹¤.
          curl -kvv https://${MASTER_IP}:6443/api/v1/nodes

          # ===================================================

          # ì—°ê²° ì§„ë‹¨ (ì´ ë¶€ë¶„ì´ ì„±ê³µí•´ì•¼ ë‹¤ìŒ ë‹¨ê³„ë¡œ ë„˜ì–´ê°ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤)
          kubectl get nodes

      # 4. ì „ì²´ k8s ë””ë ‰í† ë¦¬ ì ìš©
      - name: Apply all Kubernetes manifests
        run: |
          kubectl apply -f k8s/ --recursive

          # ë°°í¬ ë¡¤ì•„ì›ƒ ìƒíƒœ í™•ì¸ (ì•ˆì •ì„± ê°•í™”)
          kubectl rollout status deployment/fullerting-backend-deployment --timeout=480s
