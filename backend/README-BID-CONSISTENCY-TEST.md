# ? ? ??? E2E ???  ???

## 개요

? 문서? ????? ?로젝?? ? ? ????? ??? ???? 보장?? ? ???? E2E ???? ???? ?명입??.

## ? ? **중요: ??  돌  ??**

??? ?경?? 기존 ?? ?경과 ??  돌?  ??? ? ?? ? ? ?? ??????:

### 기존 ?? ? ? ??:

- **MongoDB**: 27017
- **Redis**: 6379
- **Kafka**: 9092

### ??? ? ? ??:

- **MongoDB**: 27018
- **Redis**: 6380
- **Kafka**: 9094 (KRaft  드)

## ???  적

? ? ???? ?? ? 들? ???? ? ??? ?  ? 증합??:

1. **?? ? ? ? ??? ???**: ?? ??? ? ??? ?찰할 ? ??? ? ?? 보장
2. **?찰??  ?  ? 로직 ???**: ?? ? 보다 ????  ?  으 ? ? ? ?? ? ??? ?? 처리
3. **?찰자 ? 계산 ???**: ???  법? ? 계산? ?찰자 ?? ?치성
4. **Redis 캐시??? DB ??? ???**: 캐시? ?????? ?? DB ???? ?기화
5. **? ? ? ?? ???**: ? ? ? ? ? ??? ??? ???

## ???  조

### 1. BidConsistencyE2ETest.java

- 메인 ??? ???
-  ? ??? ? 별 개별 ??? 메서? ??
- ??? ??? ? ??  ????? ? ?  성

### 2. BidConsistencyTestReporter.java

- ??? 결과 분석  ?  포? ??
- ??? ?? 계산
- ??? ??? 분석 ? ? ? ?

### 3. ?? ???

- `application-test.yml`: ??? ? ? ?? (??: 27018, 6380, 9094)
- `docker-compose-test.yml`: ???? ??? ?비스 (MongoDB, Redis, Kafka KRaft  드)

## ??? ? ?  성

### KRaft  드 ?? ??

??? ?경에?? Kafka KRaft(Kafka Raft)  드 ? ?????:

#### ?? **KRaft  드? ??**

- **Zookeeper ?존성 ? ?**: ? ? Zookeeper ?? Kafka ?체에? 메?????  ?  ?
- **?? ??**: ? 빠른  트 ? ??? 처리 (? 2-3  ? 빠름)
- **?? ???**: ??? ???? ? ??  ?  ?
- ** 소? ??**: Zookeeper  테?? 불필? (메모 ?, CPU ??)
- **???**: ? ???? ?? ??  ??

#### ?? **기존 Zookeeper  드????  이**

- **Zookeeper  드**: `KAFKA_ZOOKEEPER_CONNECT` ?? ??
- **KRaft  드**: `KAFKA_PROCESS_ROLES: 'broker,controller'` ??? ? ? ?  ?  ?

#### ?? **??? ? ?  성**

```yaml
# KRaft 모드 ??
KAFKA_NODE_ID: 1
KAFKA_PROCESS_ROLES: "broker,controller"
KAFKA_CONTROLLER_QUORUM_VOTERS: "1@kafka-test:29093"
KAFKA_LISTENERS: "PLAINTEXT://kafka-test:9092,CONTROLLER://kafka-test:29093"
```

## ??? ?? 오

### ?? 오 1: ?? ? ? ??? ???  ?  ?

```
Given: 50개의 ???? ??? ?? ??
When: ? ???? ?차적?? 증???? ?찰??? ??
Then:
  - 모든 ?찰이 ?바르? 처리??? ?
  - ???? ?? ???? ?찰????? ?치해? ?
  - ?찰자 ?? ??? 계산??? ?
```

### ?? 오 2: ?찰??  ?  ? 로직 ???  ?  ?

```
Given: ???보다 ???? ?격으? ?? ??
When: ?? 처리 ??
Then:
  - ??? ??? 발생?? ?
  - ???? ?경되? ??? ?
```

### ?? 오 3: Redis 캐시??? DB ??? ???  ?  ?

```
Given: ?? ???? ???
When: Redis 캐시??? DB ???? 각각 조회
Then:
  - 캐시? ??? ???? DB ??? ?? ?치해? ?
  - 캐시? ???? 최신 ???? ?
```

## ??  법

### 1. ??? ? ?  ?  ?

#### Windows ? ?

```bash
# 배치 ??립트 ?? (권장)
run-bid-consistency-test.bat
```

#### Linux/Mac ? ?

```bash
# ???? ??? ?비스 ??
docker-compose -f docker-compose-test.yml up -d

# ?비스 ?? ???? (30?)
sleep 30

# Gradle? ?? ??? ??
./gradlew test --tests "com.ssafy.fullerting.BidConsistencyE2ETest" --info

# ??? ?? ??
docker-compose -f docker-compose-test.yml down
```

### 2. 개별 ??? ??

```bash
# ?? ??? 메서?? ??
./gradlew test --tests "com.ssafy.fullerting.BidConsistencyE2ETest.testConcurrentBidsDataConsistencyWithLock"

# ??? ???? ??
./gradlew test --tests "*Concurrent*"

# ??? ?? ???? ??
./gradlew test --tests "*Consistency*"
```

## ??  돌 문제 ? ?

### 문제 ??

기존 ?? ?경과 ??? ?경이 같?? ?? ? ??? ?  돌? 발생???.

### ? ?  법

1. **??? ? 기존 ?비스 ?? ??**:

   ```bash
   docker ps --format "table {{.Names}}\t{{.Ports}}\t{{.Status}}"
   ```

2. **???? ?비스? 별도 ?? ??**:

   - MongoDB: 27018
   - Redis: 6380
   - Kafka: 9094

3. **??? ? ? ? ? ?**:
   ```bash
   docker-compose -f docker-compose-test.yml down
   ```

### ??  돌 ? ????

```bash
# ?? ?? 중인 ?로세? ??
netstat -ano | findstr :27017
netstat -ano | findstr :6379
netstat -ano | findstr :9092

# Docker 컨테?? ?? ??
docker ps -a
```

## ??? 결과 ??

### ??? ?? 기??

- **90% ??**: ?? ?? - ???? ???? ? ??
- **70-89%**: ?? ?? - ? ? ??? 문제 ? ?? ? ??
- **70% 미만**: ?? 주의 ?? - ?각한 ??? 문제  ???

### 주요  ?  ? ? ?

1. **?? ? ???**: DB? ?? ???? ?? 최고 ?찰??? ?치성
2. **?찰자 ? ???**: 계산? ?찰자 ???? ????? ?찰자 ?? ?치성
3. **? ? ?? ???**: ?찰??  ? ?간순? ? ?름차? ???? ?? ? ??
4. **캐시 ???**: Redis 캐시??? DB ???? ?기화 ??

## 문제 ? ?

### ?반적? 문제?

#### 1. MongoDB ? ? ??

```bash
# MongoDB 컨테?? ?? ??
docker ps | grep mongodb-test

# MongoDB 로그 ??
docker logs mongodb-test

# ?? ?? (27018 ??)
netstat -ano | findstr :27018
```

#### 2. Redis ? ? ??

```bash
# Redis 컨테?? ?? ??
docker ps | grep redis-test

# Redis ?? ??? (?? 6380 ??)
docker exec -it redis-test redis-cli -p 6380 ping
```

#### 3. Kafka ? ? ??

```bash
# Kafka 컨테?? ?? ??
docker ps | grep kafka-test

# Kafka ?? ?? ?? (?? 9094 ??)
docker exec -it kafka-test kafka-topics --list --bootstrap-server localhost:9094
```

### ??? ?? ? ?버깅

1. **로그 ? ? 조정**: `application-test.yml`?? 로깅 ? 을 DEBUG  ? ??
2. **개별 ??? ??**: ??? ??? ? ? ? ???? ?? 로그 ??
3. **??? ?? ??**: `BidConsistencyTestReporter` ? ???? ?? ?? 분석
4. **??  돌 ??**: `netstat` 명령? ? ?? ?? ?? ??

## ?? 고려??

### ??? ??? ??

- **??? ??? ? ?**: 20  ? (CPU 코어 ?? ?? 조정  ??)
- **?? ? ? ?**: 50  ? (??? ??? ?? 조정  ??)
- **??????**: 30  ? (????  ?? 고려)

###  소? ???

- **메모 ?**: ???? ? 100-200MB
- **CPU**: ??? ??? ? ???? CPU ?? ?
- **????**: Kafka 메시 ? ??? ? ?? ???? ???

## ??  ??? ??? ?? 오

### 추?? 고려??

1. **?? 복구 ???**: ?비스 중단 ? 복구 ? ???  ?  ?
2. ** ?? ???**: ????? ??? 처리 ? ??? ? ? ??
3. **????  ?? ???**: ???? 불안? ????? ???  ?  ?
4. **??? 마이그레?? ???**: ?? ?  ?  ? ? ??? 보장 ??

## ? ? 문서

- [BidConcurrencyTest.java](./src/test/java/com/ssafy/fullerting/BidConcurrencyTest.java): 기존 ??? ???
- [BidConsumerService.java](./src/main/java/com/ssafy/fullerting/global/kafka/BidConsumerService.java): ? ? 처리 ?비스
- [BidService.java](./src/main/java/com/ssafy/fullerting/bidLog/service/BidService.java): ? ? 비즈?? 로직

## 문의??

??? ??  ? 문제 ? 발생?거나 개선 ??? ?? ? 개발???? 문의?주세?.
